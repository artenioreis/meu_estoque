{% extends 'base.html' %}

{% block title %}PDV - Ponto de Venda{% endblock %}

{% block extra_styles %}
<style>
    body {
        background-image: url('https://img.freepik.com/fotos-premium/fundo-de-textura-de-papel-rosa-claro_164935-252.jpg');
        background-size: cover;
        background-attachment: fixed;
    }
    .card {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
    }
    #resultadoBusca, #resultadoBuscaCliente {
        position: absolute;
        z-index: 1050;
        width: 95%;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Coluna da Venda -->
    <div class="col-md-7">
        <h1 class="mb-4">Ponto de Venda</h1>
        
        <!-- Busca de Cliente -->
        <div class="input-group mb-3">
            <span class="input-group-text"><i class="fas fa-user"></i></span>
            <input type="text" id="buscaCliente" class="form-control" placeholder="Buscar cliente (opcional)...">
        </div>
        <div id="resultadoBuscaCliente" class="list-group"></div>

        <!-- Busca de Produto -->
        <div class="input-group mb-3">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="buscaProduto" class="form-control" placeholder="Digite o código ou nome do produto...">
        </div>
        <div id="resultadoBusca" class="list-group"></div>
        
        <hr class="mt-5">

        <!-- Itens da Venda -->
        <div class="card">
            <div class="card-header">Itens da Venda</div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th style="width: 120px;">Qtd.</th>
                            <th>Preço Unit.</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="itensVenda">
                        <!-- Itens são adicionados aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Coluna do Total e Finalização -->
    <div class="col-md-5">
        <div class="card" style="position: sticky; top: 20px;">
            <div class="card-body">
                <div id="clienteSelecionado" class="alert alert-info" style="display: none;">
                    <strong>Cliente:</strong> <span id="nomeCliente"></span>
                    <button id="removerCliente" class="btn-close float-end"></button>
                </div>
                <h3 class="card-title text-center">Total da Venda</h3>
                <h1 class="display-4 text-center mb-4" id="valorTotal">R$ 0,00</h1>
                <form id="formVenda" action="{{ url_for('finalizar_venda') }}" method="POST" target="_blank">
                    <input type="hidden" name="venda_data" id="vendaDataInput">
                    <input type="hidden" name="cliente_id" id="clienteIdInput">

                    <!-- SELEÇÃO DA FORMA DE PAGAMENTO -->
                    <div class="my-3">
                        <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
                        <select name="forma_pagamento" id="formaPagamento" class="form-select" required>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Pix">Pix</option>
                            <option value="Cartão">Cartão</option>
                            <option value="A Prazo">A Prazo</option>
                        </select>
                    </div>

                    <!-- CAMPO DE PARCELAS (aparece dinamicamente) -->
                    <div class="my-3" id="campoParcelas" style="display: none;">
                        <label for="parcelas" class="form-label">Número de Parcelas</label>
                        <select name="parcelas" id="parcelas" class="form-select">
                            {% for i in range(1, 11) %}
                                <option value="{{ i }}">{{ i }}x</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success btn-lg w-100" id="btnFinalizar">
                        <i class="fas fa-check-circle"></i> Finalizar Venda
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos do DOM
    const buscaProdutoInput = document.getElementById('buscaProduto');
    const resultadoBusca = document.getElementById('resultadoBusca');
    const buscaClienteInput = document.getElementById('buscaCliente');
    const resultadoBuscaCliente = document.getElementById('resultadoBuscaCliente');
    const itensVendaBody = document.getElementById('itensVenda');
    const valorTotalEl = document.getElementById('valorTotal');
    const formVenda = document.getElementById('formVenda');
    const vendaDataInput = document.getElementById('vendaDataInput');
    const clienteIdInput = document.getElementById('clienteIdInput');
    const clienteSelecionadoDiv = document.getElementById('clienteSelecionado');
    const nomeClienteSpan = document.getElementById('nomeCliente');
    const removerClienteBtn = document.getElementById('removerCliente');
    const formaPagamentoSelect = document.getElementById('formaPagamento');
    const campoParcelasDiv = document.getElementById('campoParcelas');
    
    // URLs das APIs
    const produtoApiUrl = "{{ url_for('buscar_produto') }}";
    const clienteApiUrl = "{{ url_for('buscar_cliente') }}";

    let vendaItens = [];

    // Função genérica para busca
    function setupBusca(inputElement, resultElement, apiUrl, onSelect) {
        inputElement.addEventListener('keyup', function() {
            const query = inputElement.value;
            if (query.length < 2) {
                resultElement.innerHTML = '';
                return;
            }
            fetch(`${apiUrl}?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    resultElement.innerHTML = '';
                    data.forEach(item => {
                        const link = document.createElement('a');
                        link.href = '#';
                        link.className = 'list-group-item list-group-item-action';
                        link.textContent = item.nome + (item.telefone ? ` (${item.telefone})` : ` (R$ ${item.preco_venda.toFixed(2)})`);
                        link.onclick = (e) => {
                            e.preventDefault();
                            onSelect(item);
                            inputElement.value = '';
                            resultElement.innerHTML = '';
                            inputElement.focus();
                        };
                        resultElement.appendChild(link);
                    });
                })
                .catch(error => console.error('Erro na busca:', error));
        });
    }

    // Configura a busca de produtos e clientes
    setupBusca(buscaProdutoInput, resultadoBusca, produtoApiUrl, adicionarItemVenda);
    setupBusca(buscaClienteInput, resultadoBuscaCliente, clienteApiUrl, selecionarCliente);

    function adicionarItemVenda(produto) {
        const itemExistente = vendaItens.find(item => item.id === produto.id);
        if (itemExistente) {
            itemExistente.quantidade++;
        } else {
            vendaItens.push({ ...produto, quantidade: 1 });
        }
        atualizarTabelaVenda();
    }

    function selecionarCliente(cliente) {
        clienteIdInput.value = cliente.id;
        nomeClienteSpan.textContent = cliente.nome;
        clienteSelecionadoDiv.style.display = 'block';
        buscaClienteInput.style.display = 'none';
    }

    removerClienteBtn.addEventListener('click', function() {
        clienteIdInput.value = '';
        clienteSelecionadoDiv.style.display = 'none';
        buscaClienteInput.style.display = 'block';
        buscaClienteInput.value = '';
        buscaClienteInput.focus();
    });

    function atualizarTabelaVenda() {
        itensVendaBody.innerHTML = '';
        let total = 0;
        vendaItens.forEach((item, index) => {
            const subtotal = item.quantidade * item.preco_venda;
            total += subtotal;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.nome}</td>
                <td><input type="number" class="form-control form-control-sm" value="${item.quantidade}" min="1" data-index="${index}"></td>
                <td>R$ ${item.preco_venda.toFixed(2)}</td>
                <td>R$ ${subtotal.toFixed(2)}</td>
                <td><button class="btn btn-danger btn-sm" data-index="${index}">&times;</button></td>
            `;
            itensVendaBody.appendChild(tr);
        });
        valorTotalEl.textContent = `R$ ${total.toFixed(2)}`;
        vendaDataInput.value = JSON.stringify(vendaItens);
    }

    itensVendaBody.addEventListener('change', function(e) {
        if (e.target.tagName === 'INPUT') {
            const index = e.target.dataset.index;
            const novaQtd = parseInt(e.target.value);
            if (novaQtd > 0) {
                vendaItens[index].quantidade = novaQtd;
            }
            atualizarTabelaVenda();
        }
    });

    itensVendaBody.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON') {
            const index = e.target.dataset.index;
            vendaItens.splice(index, 1);
            atualizarTabelaVenda();
        }
    });
    
    formaPagamentoSelect.addEventListener('change', function() {
        if (this.value === 'A Prazo') {
            campoParcelasDiv.style.display = 'block';
        } else {
            campoParcelasDiv.style.display = 'none';
        }
    });

    formVenda.addEventListener('submit', function(event) {
        if (vendaItens.length === 0) {
            alert("Adicione pelo menos um item à venda antes de finalizar.");
            event.preventDefault();
            return;
        }
        if (formaPagamentoSelect.value === 'A Prazo' && !clienteIdInput.value) {
            alert("É necessário selecionar um cliente para vendas a prazo.");
            event.preventDefault();
            return;
        }
        setTimeout(() => {
            vendaItens = [];
            removerClienteBtn.click();
            atualizarTabelaVenda();
        }, 1000);
    });
});
</script>
{% endblock %}
